#!/usr/bin/env bash
# Deploy completo de todas as prioridades (P0 + P1)
# Executa todos os scripts de deploy e validaรงรฃo em ordem

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "๐ Deploy Completo โ P0 + P1"
echo "============================="
echo ""
echo "Ordem de execuรงรฃo:"
echo "  1. Observabilidade (P0)"
echo "  2. Webhooks Worker (P1)"
echo "  3. Billing Quota-DO (P1)"
echo "  4. Validaรงรฃo Files/R2 (P1)"
echo "  5. Validaรงรฃo Admin (P1)"
echo "  6. Smoke RTC (P1)"
echo ""

read -p "Continuar? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Cancelado."
  exit 0
fi

echo ""

# 1. Observabilidade
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "1๏ธโฃ  Observabilidade (P0)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
"${SCRIPT_DIR}/deploy-observability.sh"
echo ""

# 2. Webhooks
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "2๏ธโฃ  Webhooks Worker (P1)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
"${SCRIPT_DIR}/deploy-webhooks.sh"
echo ""

# 3. Billing
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "3๏ธโฃ  Billing Quota-DO (P1)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
"${SCRIPT_DIR}/deploy-billing.sh"
echo ""

# 4. Files/R2
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "4๏ธโฃ  Validaรงรฃo Files/R2 (P1)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
"${SCRIPT_DIR}/validate-files-r2.sh"
echo ""

# 5. Admin
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "5๏ธโฃ  Validaรงรฃo Admin (P1)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
"${SCRIPT_DIR}/validate-admin.sh"
echo ""

# 6. RTC Smoke
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "6๏ธโฃ  Smoke RTC (P1)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
"${SCRIPT_DIR}/smoke_rtc.sh"
echo ""

echo "โโโ DEPLOY COMPLETO!"
echo "====================="
echo ""
echo "๐ Resumo:"
echo "   โ Observabilidade (P0)"
echo "   โ Webhooks Worker (P1)"
echo "   โ Billing Quota-DO (P1)"
echo "   โ Files/R2 validado (P1)"
echo "   โ Admin validado (P1)"
echo "   โ RTC smoke executado (P1)"
echo ""
echo "๐ Prรณximos passos:"
echo "   โข Configurar datasource Prometheus no Grafana"
echo "   โข Importar dashboards no Grafana"
echo "   โข Testar webhooks com HMAC real"
echo "   โข Testar RTC com 2 clientes (manual)"
echo ""
