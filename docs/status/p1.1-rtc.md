# P1.1 — RTC estável (2 clientes na mesma sala)

**Objetivo:** Validar WebSocket RTC com handshake, presence, ping/pong e signal entre 2 clientes.

---

## Pré-requisitos

```bash
# Health check deve responder ok:true
curl -s https://rtc.voulezvous.tv/healthz | jq
```

---

## Passo a Passo

### 1. Criar sala (opcional)

```bash
curl -sX POST https://api.ubl.agency/rtc/rooms \
  -H 'content-type: application/json' \
  -d '{"tenant":"voulezvous","room_id":"lab-demo","ttl":3600}' | jq
```

Se o endpoint ainda não emite token, tudo bem: o WS aceita sem.

### 2. Abrir dois clientes WebSocket (A e B)

**Terminal A (Alice):**
```bash
wscat -c "wss://rtc.voulezvous.tv/rooms/lab-demo?client_id=alice&tenant=voulezvous"
```

**Terminal B (Bob):**
```bash
wscat -c "wss://rtc.voulezvous.tv/rooms/lab-demo?client_id=bob&tenant=voulezvous"
```

**Alternativa com websocat:**
```bash
# Terminal A
websocat "wss://rtc.voulezvous.tv/rooms/lab-demo?client_id=alice&tenant=voulezvous"

# Terminal B
websocat "wss://rtc.voulezvous.tv/rooms/lab-demo?client_id=bob&tenant=voulezvous"
```

### 3. Handshake

Em cada terminal, envie:

**Alice:**
```json
{"type":"hello","client_id":"alice","room_id":"lab-demo"}
```

**Bob:**
```json
{"type":"hello","client_id":"bob","room_id":"lab-demo"}
```

**Esperado em cada cliente:**
```json
{"type":"ack","ok":true,"room_id":"lab-demo"}
```

### 4. Presença (broadcast)

No terminal A (Alice), envie:
```json
{"type":"presence.update","status":"online"}
```

**Esperado no terminal B (Bob):**
```json
{"type":"presence.update","client_id":"alice","status":"online"}
```

### 5. Ping / Latência

Em cada terminal, envie 3 vezes:
```json
{"type":"ping","t":1736000000000}
```

**Esperado na própria sessão:**
```json
{"type":"pong","t":1736000000000}
```

**Meta:** Mediana de RTT < 150ms (rede normal). Se >150ms, repetir teste fora de VPN/4G.

### 6. Sinalização (encaminhamento)

No terminal A (Alice), envie um sinal "fake":
```json
{"type":"signal","to":"bob","payload":{"kind":"offer","sdp":"TEST"}}
```

**Esperado no terminal B (Bob):**
```json
{"type":"signal","from":"alice","payload":{"kind":"offer","sdp":"TEST"}}
```

---

## Proof of Done

- ✅ `healthz` → `{"ok":true}`
- ✅ Ambos recebem `ack` após `hello`
- ✅ Bob recebe `presence.update` de Alice
- ✅ RTT (3 pings por cliente) mediana < 150ms
- ✅ Bob recebe `signal` encaminhado por Alice

---

## Scripts Automatizados

### Smoke test completo
```bash
./scripts/smoke_rtc.sh
```

### Comandos para teste manual
```bash
./scripts/test_rtc_manual.sh
```

Este script gera comandos prontos para copy-paste em 2 terminais.

---

## Troubleshooting

### 401/302 no WS
Verificar se o subdomínio `rtc.voulezvous.tv` não está protegido por Access. Deve ser público.

### Sem broadcast de presença
Conferir que `client_id` é único por conexão e que ambos enviaram `hello` primeiro.

### RTT alto
- Testar de rede fixa, sem VPN
- Cloudflare colo no EU é ideal
- Verificar latência até `rtc.voulezvous.tv`

### WebSocket não conecta
```bash
# Verificar se Worker está deployado
wrangler deployments list --name=vvz-rtc

# Verificar logs
wrangler tail vvz-rtc
```

---

## Instalação de Ferramentas

### websocat (Rust)
```bash
cargo install websocat
```

### wscat (Node.js)
```bash
npm install -g wscat
```

---

## Exemplo Completo

```bash
# Terminal 1 (Alice)
$ wscat -c "wss://rtc.voulezvous.tv/rooms/lab-demo?client_id=alice&tenant=voulezvous"
> {"type":"hello","client_id":"alice","room_id":"lab-demo"}
< {"type":"ack","ok":true,"room_id":"lab-demo"}
> {"type":"presence.update","status":"online"}
> {"type":"ping","t":1736000000000}
< {"type":"pong","t":1736000000000}
> {"type":"signal","to":"bob","payload":{"kind":"offer","sdp":"TEST"}}

# Terminal 2 (Bob)
$ wscat -c "wss://rtc.voulezvous.tv/rooms/lab-demo?client_id=bob&tenant=voulezvous"
> {"type":"hello","client_id":"bob","room_id":"lab-demo"}
< {"type":"ack","ok":true,"room_id":"lab-demo"}
< {"type":"presence.update","client_id":"alice","status":"online"}
> {"type":"ping","t":1736000000000}
< {"type":"pong","t":1736000000000}
< {"type":"signal","from":"alice","payload":{"kind":"offer","sdp":"TEST"}}
```

---

## Próximos Passos

Após validar P1.1:
- P1.2 — R2 Presign real (Files)
- P1.3 — Rotas Admin operacionais
- P1.4 — Observabilidade mínima
